# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Synodos is a team-based Kanban board application with a Spring Boot backend and React frontend, using PostgreSQL database for persistence. Features include JWT authentication, real-time updates via WebSocket, task comments, verification workflow, team chat, and AI-powered analysis via Gemini.

## Build and Run Commands

### Backend (Spring Boot)
```bash
cd backend
./mvnw spring-boot:run          # Start backend server (port 8081)
./mvnw clean package            # Build JAR
./mvnw test                     # Run all tests
./mvnw test -Dtest=TestClass    # Run single test class
./mvnw test -Dtest=TestClass#methodName  # Run single test method

# Windows PowerShell (use quotes around profile arg)
.\mvnw spring-boot:run "-Dspring-boot.run.profiles=local"
```

### Frontend (React)
```bash
cd frontend
npm install                     # Install dependencies
npm start                       # Start dev server (port 3000, proxies to 8081)
npm run build                   # Production build
npm test                        # Run tests
npm test -- --watchAll=false    # Run tests once without watch mode
```

### Database
PostgreSQL running on localhost:5432. Schema files in `database/` folder:
- `postgresql_schema.sql` - Full consolidated schema

Setup from scratch:
```sql
CREATE DATABASE synodos;
CREATE USER flow WITH PASSWORD 'flow123';
GRANT ALL PRIVILEGES ON DATABASE synodos TO flow;
\c synodos
GRANT ALL ON SCHEMA public TO flow;
```

Initialize schema:
```bash
psql -U flow -d synodos -f database/postgresql_schema.sql
```

### Docker (Full Stack)
```bash
docker-compose up --build              # Start all services
docker-compose up -d --build           # Start in background
docker-compose down                    # Stop all services
docker-compose down -v                 # Stop and remove volumes
```

### Test Accounts
Sample data is auto-generated by `DataInitializer.java` on every Spring Boot startup.
- **Users**: user1~user30, admin (password: `1234`)
- **Teams**: 10 teams with 10 columns and 50 tasks each

Note: `data.sql` is not used - DataInitializer handles all sample data creation.

## Architecture

### Backend Structure (Spring Boot 3.2 + MyBatis + PostgreSQL)
```
backend/src/main/java/com/example/demo/
├── controller/     # REST endpoints under /api prefix
├── service/        # Business logic layer
├── dao/            # MyBatis mapper interfaces
├── model/          # Data entities with Lombok annotations
├── config/         # WebSocket and Security configuration
├── security/       # JWT token provider and authentication filter
└── dto/            # Data transfer objects (AuthResponse, BoardEvent, AnalysisRequest)
```
Key entities: Member, Team, TeamMember, SynodosColumn, Task, Comment, ChatMessage, Notification, TaskAssignee, TaskVerifier, TaskFavorite, TaskArchive, ProjectFile

### External Integrations
- **Gemini AI**: `GeminiService` calls Gemini API for AI-powered analysis (model: `gemini-2.0-flash`)
- **GitHub**: `GitHubService` for Git commit integration with tasks
- API keys configured via environment variables: `GEMINI_API_KEY`

### MyBatis Conventions
- Mapper XMLs in `resources/mapper/` (one per entity)
- Standard method names: `insert`, `update`, `delete`, `content` (get by ID), `listAll`, `listByColumn`, `listByTeam`
- Database uses `snake_case`, Java uses `camelCase` (auto-mapped via `map-underscore-to-camel-case=true`)
- Use `@Param` annotations in DAO interfaces for named parameters

### Task Workflow States
Tasks use `workflow_status` field:
- `WAITING` → `IN_PROGRESS` (assignee accepts) → `REVIEW` (submitted for review) → `DONE` (approved)
- `REJECTED` (verifier rejected, needs rework)
- `DECLINED` (assignee declined the task)

Rejections store `rejection_reason`, `rejected_at`, and `rejected_by` fields.

### Service Layer Patterns
```java
// Pattern: Populate relations after DAO fetch, trigger notifications after mutations
Task task = dao.content(id);
populateRelations(task);  // Load assignees, verifiers
dao.update(task);
notificationService.notifyTaskUpdated(task, teamId);
```

### Frontend Structure (React 18 + React Router)
```
frontend/src/
├── api/            # Axios API clients (axiosInstance, boardApi, teamApi, etc.)
├── components/     # Reusable UI (Sidebar, Header, TaskModal, ChatPanel, etc.)
├── pages/          # Route components (Login, Register, Home, TeamView, etc.)
└── pages/views/    # Board sub-views (BoardView, ListView, CalendarView, etc.)
```

### Frontend State Management
- Component-level state with React Hooks (no Redux/Context)
- localStorage keys: `token` (JWT), `member` (user info), `currentTeam`
- Axios interceptors: auto token injection, 401 redirects to login

### Real-Time Communication (WebSocket)
- Endpoint: `/ws` (STOMP over SockJS)
- Subscribe: `/topic/team/{teamId}` for board events
- Publish: `/app/presence/join/{teamId}`, `/app/presence/leave/{teamId}`
- Event types: `TASK_CREATED`, `TASK_UPDATED`, `TASK_MOVED`, `TASK_DELETED`, `COLUMN_CREATED`, etc.

### Notification System (Dual-Channel)
- **Real-time:** `BoardNotificationService` → WebSocket `/topic/team/{teamId}`
- **Persistent:** `NotificationService` → database `notification` table

### API Endpoint Pattern
Backend endpoints: `/api/{resource}{action}` (e.g., `/api/taskwrite`, `/api/tasklist`, `/api/taskdelete/{id}`)
Frontend proxy forwards all `/api/*` requests to backend port 8081.

## Key Configuration
- Backend port: 8081, Frontend dev port: 3000 (proxies to 8081)
- DB credentials: flow/flow123@localhost:5432/synodos
- Java 17, Node 18+

### Environment Variables
Copy `.env.example` to `.env` and configure:
- `DB_USERNAME`, `DB_PASSWORD` - Database credentials
- `JWT_SECRET` - JWT signing key
- `SMTP_USERNAME`, `SMTP_PASSWORD` - Gmail SMTP (requires app password)
- `GEMINI_API_KEY` - Gemini AI API key for analysis features

### Email Configuration
- `email.environment=dev` - Logs emails to console
- `email.environment=prod` - Sends via SMTP (default)
- For local SMTP, create `backend/src/main/resources/application-local.properties`:
```properties
spring.mail.username=your-email@gmail.com
spring.mail.password=your-16-digit-app-password
```

## Data Hierarchy
```
Team → SynodosColumn → Task → [Comments, TaskAssignee, TaskVerifier]
     → TeamMember (links Member to Team with role)
     → ChatMessage
```
- Drag-and-drop uses `@hello-pangea/dnd` library
- File uploads: max 50MB per file (`spring.servlet.multipart.max-file-size`)