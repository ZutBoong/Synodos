<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.ChatMessageDao">

	<!-- 메시지 생성 -->
	<insert id="insert" parameterType="chatMessage">
		<selectKey keyProperty="messageId" resultType="int" order="BEFORE">
			SELECT nextval('chat_seq')
		</selectKey>
		INSERT INTO chat_message (message_id, team_id, sender_no, content, sent_at)
		VALUES (#{messageId}, #{teamId}, #{senderNo}, #{content}, CURRENT_TIMESTAMP)
	</insert>

	<!-- 팀별 메시지 목록 (페이징) -->
	<select id="listByTeam" parameterType="map" resultType="chatMessage">
		SELECT * FROM (
			SELECT c.message_id, c.team_id, c.sender_no, m.name as sender_name, m.userid as sender_userid,
				c.content, c.sent_at
			FROM chat_message c
			JOIN member m ON c.sender_no = m.no
			WHERE c.team_id = #{teamId}
			<if test="beforeId != null">
				AND c.message_id &lt; #{beforeId}
			</if>
			ORDER BY c.sent_at DESC
			LIMIT #{limit}
		) sub
		ORDER BY sent_at ASC
	</select>

	<!-- 팀별 최근 메시지 (기본 100개) -->
	<select id="listRecentByTeam" parameterType="map" resultType="chatMessage">
		SELECT * FROM (
			SELECT c.message_id, c.team_id, c.sender_no, m.name as sender_name, m.userid as sender_userid,
				c.content, c.sent_at
			FROM chat_message c
			JOIN member m ON c.sender_no = m.no
			WHERE c.team_id = #{teamId}
			ORDER BY c.sent_at DESC
			LIMIT #{limit}
		) sub
		ORDER BY sent_at ASC
	</select>

	<!-- 메시지 상세 -->
	<select id="content" parameterType="int" resultType="chatMessage">
		SELECT c.message_id, c.team_id, c.sender_no, m.name as sender_name, m.userid as sender_userid,
			c.content, c.sent_at
		FROM chat_message c
		JOIN member m ON c.sender_no = m.no
		WHERE c.message_id = #{messageId}
	</select>

	<!-- 메시지 삭제 -->
	<delete id="delete" parameterType="int">
		DELETE FROM chat_message WHERE message_id = #{messageId}
	</delete>

</mapper>
