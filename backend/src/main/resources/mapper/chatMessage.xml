<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.ChatMessageDao">

	<!-- 메시지 생성 -->
	<insert id="insert" parameterType="chatMessage">
		<selectKey keyProperty="messageId" resultType="int" order="BEFORE">
			SELECT kari_chat_seq.nextval FROM dual
		</selectKey>
		INSERT INTO kari_chat_message (message_id, team_id, sender_no, content, sent_at)
		VALUES (#{messageId}, #{teamId}, #{senderNo}, #{content}, systimestamp)
	</insert>

	<!-- 팀별 메시지 목록 (페이징) -->
	<select id="listByTeam" parameterType="map" resultType="chatMessage">
		SELECT * FROM (
			SELECT c.message_id, c.team_id, c.sender_no, m.name as sender_name, m.userid as sender_userid,
				c.content, c.sent_at, ROWNUM as rn
			FROM (
				SELECT * FROM kari_chat_message
				WHERE team_id = #{teamId}
				<if test="beforeId != null">
					AND message_id &lt; #{beforeId}
				</if>
				ORDER BY sent_at DESC
			) c
			JOIN kari_member m ON c.sender_no = m.no
			WHERE ROWNUM &lt;= #{limit}
		)
		ORDER BY sent_at ASC
	</select>

	<!-- 팀별 최근 메시지 (기본 100개) -->
	<select id="listRecentByTeam" parameterType="map" resultType="chatMessage">
		SELECT * FROM (
			SELECT c.message_id, c.team_id, c.sender_no, m.name as sender_name, m.userid as sender_userid,
				c.content, c.sent_at
			FROM kari_chat_message c
			JOIN kari_member m ON c.sender_no = m.no
			WHERE c.team_id = #{teamId}
			ORDER BY c.sent_at DESC
		)
		WHERE ROWNUM &lt;= #{limit}
		ORDER BY sent_at ASC
	</select>

	<!-- 메시지 상세 -->
	<select id="content" parameterType="int" resultType="chatMessage">
		SELECT c.message_id, c.team_id, c.sender_no, m.name as sender_name, m.userid as sender_userid,
			c.content, c.sent_at
		FROM kari_chat_message c
		JOIN kari_member m ON c.sender_no = m.no
		WHERE c.message_id = #{messageId}
	</select>

	<!-- 메시지 삭제 -->
	<delete id="delete" parameterType="int">
		DELETE FROM kari_chat_message WHERE message_id = #{messageId}
	</delete>

</mapper>
