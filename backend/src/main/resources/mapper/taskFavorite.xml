<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.TaskFavoriteDao">

    <!-- 즐겨찾기 추가 -->
    <insert id="insert" parameterType="taskFavorite">
        INSERT INTO task_favorite (task_id, member_no, created_at)
        VALUES (#{taskId}, #{memberNo}, CURRENT_TIMESTAMP)
        ON CONFLICT (task_id, member_no) DO NOTHING
    </insert>

    <!-- 즐겨찾기 삭제 -->
    <delete id="delete">
        DELETE FROM task_favorite
        WHERE task_id = #{taskId} AND member_no = #{memberNo}
    </delete>

    <!-- 멤버별 즐겨찾기 목록 (태스크 정보 포함) -->
    <select id="listByMember" parameterType="int" resultType="taskFavorite">
        SELECT tf.task_id, tf.member_no, tf.created_at,
               t.title, t.description, t.workflow_status, t.priority, t.due_date,
               t.column_id, c.title as column_title,
               c.team_id, tm.team_name
        FROM task_favorite tf
        JOIN task t ON tf.task_id = t.task_id
        JOIN columns c ON t.column_id = c.column_id
        JOIN team tm ON c.team_id = tm.team_id
        WHERE tf.member_no = #{memberNo}
        ORDER BY tf.created_at DESC
    </select>

    <!-- 특정 즐겨찾기 조회 -->
    <select id="findOne" resultType="taskFavorite">
        SELECT task_id, member_no, created_at
        FROM task_favorite
        WHERE task_id = #{taskId} AND member_no = #{memberNo}
    </select>

    <!-- 멤버의 즐겨찾기 수 -->
    <select id="countByMember" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM task_favorite
        WHERE member_no = #{memberNo}
    </select>

</mapper>
