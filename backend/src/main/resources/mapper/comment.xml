<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.CommentDao">

	<!-- 댓글 생성 -->
	<insert id="insert" parameterType="comment">
		<selectKey keyProperty="commentId" resultType="int" order="BEFORE">
			SELECT nextval('flowtask_comment_seq')
		</selectKey>
		INSERT INTO flowtask_comment (comment_id, task_id, author_no, content, created_at, updated_at)
		VALUES (#{commentId}, #{taskId}, #{authorNo}, #{content}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
	</insert>

	<!-- 태스크별 댓글 목록 -->
	<select id="listByTask" parameterType="int" resultType="comment">
		SELECT c.comment_id, c.task_id, c.author_no, m.name as author_name, m.userid as author_userid,
			c.content, c.created_at, c.updated_at
		FROM flowtask_comment c
		JOIN flowtask_member m ON c.author_no = m.no
		WHERE c.task_id = #{taskId}
		ORDER BY c.created_at ASC
	</select>

	<!-- 댓글 상세 -->
	<select id="content" parameterType="int" resultType="comment">
		SELECT c.comment_id, c.task_id, c.author_no, m.name as author_name, m.userid as author_userid,
			c.content, c.created_at, c.updated_at
		FROM flowtask_comment c
		JOIN flowtask_member m ON c.author_no = m.no
		WHERE c.comment_id = #{commentId}
	</select>

	<!-- 댓글 수정 -->
	<update id="update" parameterType="comment">
		UPDATE flowtask_comment
		SET content = #{content}, updated_at = CURRENT_TIMESTAMP
		WHERE comment_id = #{commentId}
	</update>

	<!-- 댓글 삭제 -->
	<delete id="delete" parameterType="int">
		DELETE FROM flowtask_comment WHERE comment_id = #{commentId}
	</delete>

	<!-- 태스크별 댓글 수 -->
	<select id="countByTask" parameterType="int" resultType="int">
		SELECT COUNT(*) FROM flowtask_comment WHERE task_id = #{taskId}
	</select>

</mapper>
