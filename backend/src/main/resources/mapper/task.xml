<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.TaskDao">

	<!-- 태스크 생성 -->
	<insert id="insert" parameterType="task">
		INSERT INTO flowtask_task (task_id, column_id, title, description, position, created_at,
			assignee_no, priority, due_date, status)
		VALUES (nextval('flowtask_task_seq'), #{columnId}, #{title}, #{description, jdbcType=VARCHAR},
			#{position}, CURRENT_TIMESTAMP,
			#{assigneeNo, jdbcType=INTEGER}, #{priority, jdbcType=VARCHAR},
			#{dueDate, jdbcType=DATE}, COALESCE(#{status, jdbcType=VARCHAR}, 'OPEN'))
	</insert>

	<!-- 컬럼별 태스크 목록 -->
	<select id="listByColumn" parameterType="int" resultType="task">
		SELECT t.task_id, t.column_id, t.title, t.description, t.position, t.created_at,
			t.assignee_no, m.name as assignee_name, t.priority, t.due_date, t.status,
			t.verifier_no, v.name as verifier_name, t.verified_at, t.verification_status, t.verification_notes
		FROM flowtask_task t
		LEFT JOIN flowtask_member m ON t.assignee_no = m.no
		LEFT JOIN flowtask_member v ON t.verifier_no = v.no
		WHERE t.column_id = #{columnId}
		ORDER BY t.position ASC
	</select>

	<!-- 전체 태스크 목록 -->
	<select id="listAll" resultType="task">
		SELECT t.task_id, t.column_id, t.title, t.description, t.position, t.created_at,
			t.assignee_no, m.name as assignee_name, t.priority, t.due_date, t.status,
			t.verifier_no, v.name as verifier_name, t.verified_at, t.verification_status, t.verification_notes
		FROM flowtask_task t
		LEFT JOIN flowtask_member m ON t.assignee_no = m.no
		LEFT JOIN flowtask_member v ON t.verifier_no = v.no
		ORDER BY t.column_id, t.position ASC
	</select>

	<!-- 팀별 태스크 목록 -->
	<select id="listByTeam" parameterType="int" resultType="task">
		SELECT t.task_id, t.column_id, t.title, t.description, t.position, t.created_at,
			t.assignee_no, m.name as assignee_name, t.priority, t.due_date, t.status,
			t.verifier_no, v.name as verifier_name, t.verified_at, t.verification_status, t.verification_notes
		FROM flowtask_task t
		JOIN flowtask_column c ON t.column_id = c.column_id
		LEFT JOIN flowtask_member m ON t.assignee_no = m.no
		LEFT JOIN flowtask_member v ON t.verifier_no = v.no
		WHERE c.team_id = #{teamId}
		ORDER BY t.column_id, t.position ASC
	</select>

	<!-- 프로젝트별 태스크 목록 -->
	<select id="listByProject" parameterType="int" resultType="task">
		SELECT t.task_id, t.column_id, t.title, t.description, t.position, t.created_at,
			t.assignee_no, m.name as assignee_name, t.priority, t.due_date, t.status,
			t.verifier_no, v.name as verifier_name, t.verified_at, t.verification_status, t.verification_notes
		FROM flowtask_task t
		JOIN flowtask_column c ON t.column_id = c.column_id
		LEFT JOIN flowtask_member m ON t.assignee_no = m.no
		LEFT JOIN flowtask_member v ON t.verifier_no = v.no
		WHERE c.project_id = #{projectId}
		ORDER BY t.column_id, t.position ASC
	</select>

	<!-- 태스크 상세 -->
	<select id="content" parameterType="int" resultType="task">
		SELECT t.task_id, t.column_id, t.title, t.description, t.position, t.created_at,
			t.assignee_no, m.name as assignee_name, t.priority, t.due_date, t.status,
			t.verifier_no, v.name as verifier_name, t.verified_at, t.verification_status, t.verification_notes
		FROM flowtask_task t
		LEFT JOIN flowtask_member m ON t.assignee_no = m.no
		LEFT JOIN flowtask_member v ON t.verifier_no = v.no
		WHERE t.task_id = #{taskId}
	</select>

	<!-- 태스크 수정 (전체 필드) -->
	<update id="update" parameterType="task">
		UPDATE flowtask_task
		SET title = #{title},
			description = #{description, jdbcType=VARCHAR},
			assignee_no = #{assigneeNo, jdbcType=INTEGER},
			priority = #{priority, jdbcType=VARCHAR},
			due_date = #{dueDate, jdbcType=DATE},
			status = #{status, jdbcType=VARCHAR}
		WHERE task_id = #{taskId}
	</update>

	<!-- 태스크 삭제 -->
	<delete id="delete" parameterType="int">
		DELETE FROM flowtask_task WHERE task_id = #{taskId}
	</delete>

	<!-- 태스크 위치/컬럼 변경 -->
	<update id="updatePosition" parameterType="task">
		UPDATE flowtask_task
		SET column_id = #{columnId}, position = #{position}
		WHERE task_id = #{taskId}
	</update>

	<!-- 컬럼 내 최대 position 조회 -->
	<select id="getMaxPosition" parameterType="int" resultType="int">
		SELECT COALESCE(MAX(position), 0) FROM flowtask_task WHERE column_id = #{columnId}
	</select>

	<!-- 담당자별 태스크 목록 -->
	<select id="listByAssignee" parameterType="int" resultType="task">
		SELECT t.task_id, t.column_id, t.title, t.description, t.position, t.created_at,
			t.assignee_no, m.name as assignee_name, t.priority, t.due_date, t.status,
			t.verifier_no, v.name as verifier_name, t.verified_at, t.verification_status, t.verification_notes
		FROM flowtask_task t
		LEFT JOIN flowtask_member m ON t.assignee_no = m.no
		LEFT JOIN flowtask_member v ON t.verifier_no = v.no
		WHERE t.assignee_no = #{memberNo}
		ORDER BY
			CASE t.priority
				WHEN 'CRITICAL' THEN 1
				WHEN 'HIGH' THEN 2
				WHEN 'MEDIUM' THEN 3
				WHEN 'LOW' THEN 4
			END,
			t.due_date NULLS LAST
	</select>

	<!-- 상태별 태스크 목록 (팀 내) -->
	<select id="listByStatusAndTeam" parameterType="map" resultType="task">
		SELECT t.task_id, t.column_id, t.title, t.description, t.position, t.created_at,
			t.assignee_no, m.name as assignee_name, t.priority, t.due_date, t.status,
			t.verifier_no, v.name as verifier_name, t.verified_at, t.verification_status, t.verification_notes
		FROM flowtask_task t
		JOIN flowtask_column c ON t.column_id = c.column_id
		LEFT JOIN flowtask_member m ON t.assignee_no = m.no
		LEFT JOIN flowtask_member v ON t.verifier_no = v.no
		WHERE c.team_id = #{teamId}
		AND t.status = #{status}
		ORDER BY
			CASE t.priority
				WHEN 'CRITICAL' THEN 1
				WHEN 'HIGH' THEN 2
				WHEN 'MEDIUM' THEN 3
				WHEN 'LOW' THEN 4
			END,
			t.due_date NULLS LAST
	</select>

	<!-- 상태만 변경 -->
	<update id="updateStatus" parameterType="task">
		UPDATE flowtask_task
		SET status = #{status}
		WHERE task_id = #{taskId}
	</update>

	<!-- 담당자만 변경 -->
	<update id="updateAssignee" parameterType="task">
		UPDATE flowtask_task
		SET assignee_no = #{assigneeNo, jdbcType=INTEGER}
		WHERE task_id = #{taskId}
	</update>

	<!-- 검증자 지정 -->
	<update id="updateVerifier" parameterType="task">
		UPDATE flowtask_task
		SET verifier_no = #{verifierNo, jdbcType=INTEGER},
			verification_status = CASE
				WHEN #{verifierNo, jdbcType=INTEGER} IS NOT NULL THEN 'PENDING'
				ELSE 'NONE'
			END
		WHERE task_id = #{taskId}
	</update>

	<!-- 검증 처리 (승인/반려) -->
	<update id="updateVerification" parameterType="task">
		UPDATE flowtask_task
		SET verification_status = #{verificationStatus},
			verified_at = CASE
				WHEN #{verificationStatus} IN ('APPROVED', 'REJECTED') THEN CURRENT_TIMESTAMP
				ELSE NULL
			END,
			verification_notes = #{verificationNotes, jdbcType=VARCHAR},
			status = CASE
				WHEN #{verificationStatus} = 'APPROVED' THEN 'CLOSED'
				WHEN #{verificationStatus} = 'REJECTED' THEN 'IN_PROGRESS'
				ELSE status
			END
		WHERE task_id = #{taskId}
	</update>

	<!-- 내 검증 대기 목록 -->
	<select id="listPendingVerification" parameterType="int" resultType="task">
		SELECT t.task_id, t.column_id, t.title, t.description, t.position, t.created_at,
			t.assignee_no, m.name as assignee_name, t.priority, t.due_date, t.status,
			t.verifier_no, v.name as verifier_name, t.verified_at, t.verification_status, t.verification_notes
		FROM flowtask_task t
		LEFT JOIN flowtask_member m ON t.assignee_no = m.no
		LEFT JOIN flowtask_member v ON t.verifier_no = v.no
		WHERE t.verifier_no = #{verifierNo}
		AND t.verification_status = 'PENDING'
		ORDER BY
			CASE t.priority
				WHEN 'CRITICAL' THEN 1
				WHEN 'HIGH' THEN 2
				WHEN 'MEDIUM' THEN 3
				WHEN 'LOW' THEN 4
			END,
			t.created_at ASC
	</select>

	<!-- 캘린더용 날짜 범위 조회 (팀 내, 마감일 기준) -->
	<select id="listByDateRange" parameterType="map" resultType="task">
		SELECT t.task_id, t.column_id, t.title, t.description, t.position, t.created_at,
			t.assignee_no, m.name as assignee_name, t.priority, t.due_date, t.status,
			t.verifier_no, v.name as verifier_name, t.verified_at, t.verification_status, t.verification_notes
		FROM flowtask_task t
		JOIN flowtask_column c ON t.column_id = c.column_id
		LEFT JOIN flowtask_member m ON t.assignee_no = m.no
		LEFT JOIN flowtask_member v ON t.verifier_no = v.no
		WHERE c.team_id = #{teamId}
		AND t.due_date IS NOT NULL
		AND t.due_date BETWEEN #{startDate} AND #{endDate}
		ORDER BY t.due_date ASC, t.priority ASC
	</select>

</mapper>
