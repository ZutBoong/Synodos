<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.TaskAssigneeDao">

    <!-- 담당자 추가 -->
    <insert id="insert" parameterType="taskAssignee">
        INSERT INTO task_assignee (task_id, member_no, assigned_at, assigned_by, accepted, completed)
        VALUES (#{taskId}, #{memberNo}, CURRENT_TIMESTAMP, #{assignedBy}, false, false)
        ON CONFLICT (task_id, member_no) DO NOTHING
    </insert>

    <!-- 담당자 삭제 -->
    <delete id="delete">
        DELETE FROM task_assignee
        WHERE task_id = #{taskId} AND member_no = #{memberNo}
    </delete>

    <!-- 태스크의 모든 담당자 삭제 -->
    <delete id="deleteByTask" parameterType="int">
        DELETE FROM task_assignee
        WHERE task_id = #{taskId}
    </delete>

    <!-- 태스크별 담당자 목록 -->
    <select id="listByTask" parameterType="int" resultType="taskAssignee">
        SELECT ta.task_id, ta.member_no, ta.assigned_at, ta.assigned_by,
               ta.accepted, ta.accepted_at, ta.completed, ta.completed_at,
               m.name as member_name, m.userid as member_userid
        FROM task_assignee ta
        JOIN member m ON ta.member_no = m.no
        WHERE ta.task_id = #{taskId}
        ORDER BY ta.assigned_at ASC
    </select>

    <!-- 멤버별 담당 태스크 목록 -->
    <select id="listByMember" parameterType="int" resultType="taskAssignee">
        SELECT ta.task_id, ta.member_no, ta.assigned_at, ta.assigned_by,
               ta.accepted, ta.accepted_at, ta.completed, ta.completed_at,
               m.name as member_name, m.userid as member_userid
        FROM task_assignee ta
        JOIN member m ON ta.member_no = m.no
        WHERE ta.member_no = #{memberNo}
        ORDER BY ta.assigned_at DESC
    </select>

    <!-- 태스크 담당자 수 -->
    <select id="countByTask" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM task_assignee
        WHERE task_id = #{taskId}
    </select>

    <!-- 담당자 수락 -->
    <update id="acceptTask">
        UPDATE task_assignee
        SET accepted = true, accepted_at = CURRENT_TIMESTAMP
        WHERE task_id = #{taskId} AND member_no = #{memberNo}
    </update>

    <!-- 담당자 완료 처리 -->
    <update id="completeTask">
        UPDATE task_assignee
        SET completed = true, completed_at = CURRENT_TIMESTAMP
        WHERE task_id = #{taskId} AND member_no = #{memberNo}
    </update>

    <!-- 모든 담당자 수락 여부 확인 -->
    <select id="allAssigneesAccepted" parameterType="int" resultType="boolean">
        SELECT CASE
            WHEN COUNT(*) = 0 THEN true
            ELSE NOT EXISTS (
                SELECT 1 FROM task_assignee
                WHERE task_id = #{taskId} AND accepted = false
            )
        END
        FROM task_assignee WHERE task_id = #{taskId}
    </select>

    <!-- 모든 담당자 완료 여부 확인 -->
    <select id="allAssigneesCompleted" parameterType="int" resultType="boolean">
        SELECT CASE
            WHEN COUNT(*) = 0 THEN true
            ELSE NOT EXISTS (
                SELECT 1 FROM task_assignee
                WHERE task_id = #{taskId} AND completed = false
            )
        END
        FROM task_assignee WHERE task_id = #{taskId}
    </select>

    <!-- 수락 상태 초기화 (반려시 재수락 필요) -->
    <update id="resetAcceptance" parameterType="int">
        UPDATE task_assignee
        SET accepted = false, accepted_at = NULL
        WHERE task_id = #{taskId}
    </update>

    <!-- 완료 상태 초기화 (반려시 재완료 필요) -->
    <update id="resetCompletion" parameterType="int">
        UPDATE task_assignee
        SET completed = false, completed_at = NULL
        WHERE task_id = #{taskId}
    </update>

</mapper>
