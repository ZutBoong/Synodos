<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.NotificationDao">

    <!-- 알림 생성 -->
    <insert id="insert" parameterType="notification">
        INSERT INTO notification (
            notification_id, recipient_no, sender_no, notification_type,
            title, message, team_id, column_id, task_id, is_read, created_at
        ) VALUES (
            nextval('notification_seq'), #{recipientNo}, #{senderNo}, #{notificationType},
            #{title}, #{message}, #{teamId}, #{columnId}, #{taskId}, false, CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 읽음 처리 -->
    <update id="markAsRead" parameterType="int">
        UPDATE notification
        SET is_read = true
        WHERE notification_id = #{notificationId}
    </update>

    <!-- 모두 읽음 처리 -->
    <update id="markAllAsRead" parameterType="int">
        UPDATE notification
        SET is_read = true
        WHERE recipient_no = #{recipientNo} AND is_read = false
    </update>

    <!-- 알림 삭제 -->
    <delete id="delete" parameterType="int">
        DELETE FROM notification
        WHERE notification_id = #{notificationId}
    </delete>

    <!-- 모든 알림 삭제 -->
    <delete id="deleteAllByRecipient" parameterType="int">
        DELETE FROM notification
        WHERE recipient_no = #{recipientNo}
    </delete>

    <!-- 알림 상세 조회 -->
    <select id="findById" parameterType="int" resultType="notification">
        SELECT n.*,
               s.name as sender_name, s.userid as sender_userid,
               t.team_name, c.title as column_title, tk.title as task_title
        FROM notification n
        LEFT JOIN member s ON n.sender_no = s.no
        LEFT JOIN team t ON n.team_id = t.team_id
        LEFT JOIN columns c ON n.column_id = c.column_id
        LEFT JOIN task tk ON n.task_id = tk.task_id
        WHERE n.notification_id = #{notificationId}
    </select>

    <!-- 받은 알림 목록 (최신순, 제한) -->
    <select id="listByRecipient" resultType="notification">
        SELECT n.*,
               s.name as sender_name, s.userid as sender_userid,
               t.team_name, c.title as column_title, tk.title as task_title
        FROM notification n
        LEFT JOIN member s ON n.sender_no = s.no
        LEFT JOIN team t ON n.team_id = t.team_id
        LEFT JOIN columns c ON n.column_id = c.column_id
        LEFT JOIN task tk ON n.task_id = tk.task_id
        WHERE n.recipient_no = #{recipientNo}
        ORDER BY n.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 읽지 않은 알림 목록 -->
    <select id="listUnreadByRecipient" parameterType="int" resultType="notification">
        SELECT n.*,
               s.name as sender_name, s.userid as sender_userid,
               t.team_name, c.title as column_title, tk.title as task_title
        FROM notification n
        LEFT JOIN member s ON n.sender_no = s.no
        LEFT JOIN team t ON n.team_id = t.team_id
        LEFT JOIN columns c ON n.column_id = c.column_id
        LEFT JOIN task tk ON n.task_id = tk.task_id
        WHERE n.recipient_no = #{recipientNo} AND n.is_read = false
        ORDER BY n.created_at DESC
    </select>

    <!-- 읽지 않은 알림 수 -->
    <select id="countUnread" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM notification
        WHERE recipient_no = #{recipientNo} AND is_read = false
    </select>

    <!-- 최근 24시간 내 특정 태스크에 대한 특정 타입의 알림 존재 여부 -->
    <select id="hasRecentNotification" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM notification
            WHERE task_id = #{taskId}
              AND notification_type = #{type}
              AND created_at > CURRENT_TIMESTAMP - INTERVAL '24 hours'
        )
    </select>

</mapper>
