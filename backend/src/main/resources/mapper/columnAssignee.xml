<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.ColumnAssigneeDao">

    <!-- 담당자 추가 -->
    <insert id="insert" parameterType="columnAssignee">
        INSERT INTO flowtask_column_assignee (column_id, member_no, assigned_at)
        VALUES (#{columnId}, #{memberNo}, CURRENT_TIMESTAMP)
        ON CONFLICT (column_id, member_no) DO NOTHING
    </insert>

    <!-- 담당자 삭제 -->
    <delete id="delete">
        DELETE FROM flowtask_column_assignee
        WHERE column_id = #{columnId} AND member_no = #{memberNo}
    </delete>

    <!-- 컬럼의 모든 담당자 삭제 -->
    <delete id="deleteByColumn" parameterType="int">
        DELETE FROM flowtask_column_assignee
        WHERE column_id = #{columnId}
    </delete>

    <!-- 컬럼별 담당자 목록 -->
    <select id="listByColumn" parameterType="int" resultType="columnAssignee">
        SELECT ca.column_id, ca.member_no, ca.assigned_at,
               m.name as member_name, m.userid as member_userid
        FROM flowtask_column_assignee ca
        JOIN flowtask_member m ON ca.member_no = m.no
        WHERE ca.column_id = #{columnId}
        ORDER BY ca.assigned_at ASC
    </select>

    <!-- 멤버별 담당 컬럼 목록 -->
    <select id="listByMember" parameterType="int" resultType="columnAssignee">
        SELECT ca.column_id, ca.member_no, ca.assigned_at,
               m.name as member_name, m.userid as member_userid
        FROM flowtask_column_assignee ca
        JOIN flowtask_member m ON ca.member_no = m.no
        WHERE ca.member_no = #{memberNo}
        ORDER BY ca.assigned_at DESC
    </select>

    <!-- 컬럼 담당자 수 -->
    <select id="countByColumn" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM flowtask_column_assignee
        WHERE column_id = #{columnId}
    </select>

</mapper>
